{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Envoyer un message</h2>
  <p>Utilise la cle publique et le port d'un pair pour chatter en P2P chiffre.</p>
  <div class="status">Ecoute active automatique sur le port local: {{ local_port }}</div>
  <form method="post">
    <div class="form-row">
      <label for="peer_id">Peer ID</label>
      <input id="peer_id" name="peer_id" type="text" placeholder="hex..." required>
    </div>
    <div class="form-row">
      <label for="message">Message</label>
      <textarea id="message" name="message" placeholder="Ton message" required></textarea>
    </div>
    <div class="form-row">
      <label for="port_local">Port local</label>
      <input id="port_local" name="port_local" type="number" value="{{ local_port }}" required>
    </div>
    <div class="form-row">
      <label for="peer_port">Port du pair</label>
      <input id="peer_port" name="peer_port" type="number" placeholder="7902" required>
    </div>
    <div class="form-row">
      <label for="peer_ip">IP du pair (LAN)</label>
      <input id="peer_ip" name="peer_ip" type="text" placeholder="192.168.x.x" required>
    </div>
    <button class="btn-gold" type="submit">Envoyer</button>
  </form>
  <div class="status">Conversation live</div>
  <div id="chat-feed" class="status" style="max-height: 260px; overflow: auto;"></div>
</section>
<script>
  (function () {
    const feed = document.getElementById('chat-feed');
    let lastTs = 0;

    function appendMessage(msg) {
      let who = 'Envoye';
      if (msg.direction === 'in') who = 'Recu';
      if (msg.direction === 'system') who = 'Systeme';
      const peer = msg.peer ? ` (${msg.peer})` : '';
      const line = document.createElement('div');
      line.textContent = `[${who}]${peer}: ${msg.text}`;
      line.style.whiteSpace = 'pre-wrap';
      feed.appendChild(line);
      feed.scrollTop = feed.scrollHeight;
    }

    async function poll() {
      try {
        const resp = await fetch(`/chat/messages?since=${lastTs}`);
        if (!resp.ok) return;
        const data = await resp.json();
        const msgs = data.messages || [];
        for (const m of msgs) {
          appendMessage(m);
          if (m.ts > lastTs) lastTs = m.ts;
        }
      } catch (_err) {
      }
    }

    setInterval(poll, 1200);
    poll();
  })();
</script>
{% endblock %}

